## 1. 用户输入请求信息并回车

当用户在地址栏输入关键字，回车后，浏览器会判断输入的关键字是搜索内容，还是请求的 URL。

- 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎进行搜索。
- 如果判断输入内容符合 URL 规则，地址栏会根据规则把这段内容加上协议，合成为完整的 URL。

## 2. 查找当前 URL 是否存在缓存

网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到资源，那么直接进入网络请求流程。

## 3. DNS 域名解析

DNS 解析即将域名解析为对应的 IP 地址。

1. 优先在`浏览器 DNS 缓存`中查找，如果有缓存，则直接响应用户的请求
2. 如果没有要访问的域名，就继续在`操作系统的 DNS 缓存`中查找，如果也没有，最后通过本地的 DNS 服务器查到对应的 IP 地址
3. `DNS 服务器`查询过程：
   - 如果没有找到对应的 IP 地址，浏览器会发出一个 DNS 请求到`本地 DNS 服务器`，本地 DNS 服务器会首先查询它的缓存记录，如果缓存中有此条记录，直接返回结果；
   - 如果没有找到对应的 IP 地址，
     1. 本地 DNS 服务器向`根域名服务器`发送请求，根域名服务器会返回一个所查询域的顶级域名服务器地址；
     2. 本地 DNS 服务器向`顶级域名服务器`（负责 com, org, net, edu 等顶级域名和 cn, uk, fr 等国家顶级域名）发送请求，顶级域名服务器返回一个所查询域的权威域名服务器；
     3. 本地 DNS 服务器向`权威域名服务器`（例 163.com 域名服务器）发出请求，收到一个域名和 IP 地址对应关系；
     4. 本地 DNS 服务器把 IP 地址返回浏览器，把对应关系保存在缓存中，以备下次查询时直接返回结果。

<img src="./images/dns-lookup.jpg" width="50%" ></img>

## 4. 建立 TCP 连接

拿到域名对应的 IP 地址后，浏览器会以一个随机端口（1024~65535）向 Web 服务器（httpd、nginx 等）发起 TCP 的连接请求，通过三次握手建立 TCP 连接。

1. 第一次握手：客户端 A 将标志位 SYN 置为 1 表示要建立连接，随机产生一个初始序列号 seq=x 的数据包到服务器，客户端 A 进入 SYN_SENT 状态，等待服务端 B 确认；
2. 第二次握手：服务端 B 收到数据包后由标志位 SYN=1 知道客户端 A 请求建立连接，服务端 B 将标志位 SYN 和 ACK 都置为 1，ack=x+1，随机产生一个序列号 seq=y，并将该数据包发送给客户端 A 以确认连接请求，服务端 B 进入 SYN_RCVD 状态；
3. 第三次握手：客户端 A 收到确认后，检查 ack 是否为 x+1，ACK 是否为 1，如果正确则将标志位 ACK 置为 1，ack=y+1，并将该数据包发送给服务端 B，服务端 B 检查 ack 是否为 y+1，ACK 是否为 1，如果正确则连接建立成功，客户端 A 和服务端 B 进入 ESTABLISHED 状态，完成三次握手，随后客户端 A 与服务端 B 之间可以开始传输数据了。

<img src="./images/tcp-connect.png" width="60%" ></img>

**握手为什么需要三次？**  
第二次是客户端确认服务器端收到连接请求并确认可以连接。  
第三次是服务器端确认客户端可以建立连接，防止客户端已经不需要连接，而服务器端一直等待。

三次握手是为了防止已失效的连接请求报文段突然又传送到了服务端，防止 server 端一直等待，浪费资源。
client 发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达 server。

<img src="./images/tcp-close.png" width="60%" ></img>
